<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
	<title>指标详情</title>
	<link rel="stylesheet" href="css/com.css">
	<link rel="stylesheet" href="css/info.css">
	<link rel="stylesheet" href="css/swiper-3.4.0.min.css">
	<link rel="stylesheet" href="css/mobiscroll.min.css">
	<style>
		.fg{
			margin:0 4px;
		}
		
		.scal .zbType-item span{
			font-size: 1.2em;
		}
		
		.mdata-content{
			display: none;
		}
		.mdate-choose{
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			background-color: #fff;
			z-index: 9999;
			display: none;
		}
		.mdate-input{
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: space-between;
			height: 4em;
			line-height: 4em;
			padding: 1.5em;
		}
		.mdate-input input{
			font-size: 1.5em;
			border:1px solid #999;
			padding: 0 8px;
			width: 40%;
			height: 2em;
			color: #333;
			border-radius: 3px;
		}
		.mdate-input span{
			display: inline-block;
			text-align: center;
			color: #333;
		}
		
		.mdate-close{
			padding: 1em 1.5em;
			margin-bottom:16em;
		}
		.mdate-close button{
			outline: none;
			border: none;
			background-color: transparent;
			color: #2a57ae;
			font-size: 1.4em;
			height: 1.6em;
			width: 1.6em;
		}

		.close{
			background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAD0UlEQVR4Xu2Yz0sVURTHz7FXjgUKvoUbFy7cCYJeWhTRL8vKxKJ2Qf9CtBbaBEFb/4daFiH6MlMzkFrEvYLgzoULNy6eoFBONXnjxgy85s2bOTPv3jsDb2Y5P+4938/9nnPPHYQOv7DD9UMJoHRAhxMoU6DDDVAWwVQpMDg42DMwMDDLOX9WNOcwxs5KKd8g4gvO+QY1PjKAoaEhp7+/fxURLwLAIuf8HgD8oU5k8j1/YZYB4BIAHJ+cnExsbm5+pcxJAjA6OnquUqks++KDcQsBISQ+iI0MgQSAMTYHAE/CRKWU80II5YRcLt/2NUS8EhHbKyHE46TASAB8B3xCxPMRA+bihBYr/y88f2EeUFKUBEANSoBwHwC8JOI6nusSr2IhAyBA+Mg5nzINQaf41ADyhjA8PNzd19e34lf7/8yUxvaNH6ZyQPBhi10heGzECUp8b2+vKnjXIwrekhBimpLz4W8zAVCDhPqC8LhaISSJR8QZzvnvLPUlMwBbEEyKz1QDwpRNOsG0eC0ATDnBhnhtAHRDsCVeKwBdEGyK1w6gXQi2xRsBkBVCHuKNAUgLgTF2Wkq51KrJaWefT+oN2uoDkgZP2iJd1512HEeqNhYRb0d0eGvqftYmJyk+ow4IJk84s68g4i8AUIeopm6yXq/P7O7uuhQhWd8x6oAgqAQnNMUupVw7Ojqa2tnZ+ZlVGPU7KwCCmlCtVt8DwNW44GyKt5ICjWJHRkbOOI7zoRUE2+KtA4jb6nxQ667r3tre3lZ1wcplLQUI4gPBViFYAZBCvHUIxgGoHaBarc4DwM0IT9eklN2IOBHVAwghmu7rzgujACjtreu6GFMY1+v1+h2TvYAxABTxQYcXtztIKb8cHBxMmIJgBECC+Mj2Ni8I2gEkHGxiO7w8IGgF4ItvebChtLc+hIWoomkiHbQB0CG+ocJXGGM1GxC0ANAsPuBgBULbAAyJtwahLQCGxVuBkBmAJfHGIWQCYFm8UQipAeQk3hiEVADixAPAxuHh4Q0Lv7G07g5pAJwaHx9fiPp7q8Tv7+9P7u3tHes+rbUYLxaC53mTW1tb3ymxUAEo8W/V//mIQW2Lp6TDN8/zrlEgkAAwxl4DwKOIM/tnRJzinP+g0DbxDmNsMeq3upRyTgjxNGlOEoCxsbELXV1dqwDQ0zBgXisf1tSUDurMQE0DEgA1YwhCUcQ3psM7ALib9sBEBuBDuIyIs57nPaTkV5L9dD9njD0HgJdpUjIVAN0BF2G8EkARViHPGEoH5Em/CHOXDijCKuQZQ+mAPOkXYe6Od8Bf4tg4bhYue8oAAAAASUVORK5CYII=) no-repeat;
			background-size:cover; 
		}

		.mdate-btn{
			text-align: center;
			margin-top: 1em;
		}
		.mdate-btn button{
			outline: none;
			border: none;
			font-size: 1.4em;
			padding: 0.5em 1.2em;
			margin: 0 0.5em;
			opacity: 0.8;
			border-radius: 5px;
		}
		.mdate-btn button:active{
			opacity: 1;
		}
		.mdate-btn button:last-child{
			background-color: #2a57ae;
			color: #fff;
		}
		.mdate-err{
			font-size: 1.3em;
			text-align: center;
			letter-spacing: 1px;
			color: red;
		}

	</style>
</head>
<body>
	<header>
		<div class="hLeft"><button class="back"></button></div>
		<div class="hCenter"><span>服务评价</span></div>
		<div class="hRight jg">
			<div class="jg-con"><span>全司</span></div>
		</div>
	</header>
	<section class="zbType">
		<div class="zbType-item"><span id="zbType" data-code=""></span></div>
		<div class="zbType-item" data-mdate>
			<div class="mdata-content">
				<span id="mStart"></span><span class="fg">-</span>
			</div>
			<span id="mEnd"></span>
		</div>
	</section>
	
	<div class="clear"></div>
	<!-- 机构、排名、本日/本月/本年  同比 -->
	<section class="content">
		<div class="content-box">
			
		</div>
		
	</section>

	<footer>
		<label class="qs">
			<input type="radio" name="qdRadio" value="0" >
			<i></i>
			<span>全司</span>
		</label>
		<label class="gx">
			<input type="radio" name="qdRadio" value="1">
			<i></i>
			<span>个险</span>
		</label>
		<label class="fq">
			<input type="radio" name="qdRadio" value="2">
			<i></i>
			<span>健养+渠道</span>
		</label>
		<label class="dx">
			<input type="radio" name="qdRadio" value="3">
			<i></i>
			<span>电网销</span>
		</label>
	</footer>

	<section class="mdate-choose">
		<div class="mdate-close">
			<button data-mclose class="close"></button>
		</div>
		<div class="mdate-input">
			<input type="text" readonly="readonly" id="startTime"><span>至</span>
			<input type="text" readonly="readonly" id="endTime">
		</div>
		<div class="mdate-err">
			<span data-merr></span>
		</div>
		<div class="mdate-btn">
			<button data-mclear >清空</button>
			<button data-confirm >确定</button>
		</div>
	</section>

	<script src="js/jquery.min.js"></script>
	<script src='js/swiper-3.4.0.jquery.min.js'></script>
	<script src="js/mobiscroll.min.js"></script>
	<script>

		var dataSet0 = [
			['0000000000000','全司','-','100','130'],
			['0000000000001','安徽分公司','0','20','-30'],
			['0000000000002','北京分公司','0','10','-60'],
			['0000000000003','常州分公司','0','30','-40'],
			['0000000000004','大连分公司','0','20','30'],
			['0000000000005','福建分公司','0','50','-60'],
			['0000000000006','甘肃分公司','0','-','40'],
			['0000000000007','广东分公司','0','-','30'],
			['0000000000008','广西分公司','0','50','60'],
			['0000000000009','贵州分公司','0','30','-40'],
			['00000000000010','海南分公司','0','50','-60'],
			['00000000000011','河北分公司','0','30','-40']
		];

		//日、渠道为全司 的指标 
		var dataSet1 = [
			['H001','出险支付时效','正'],
			['H002','申请支付时效','正'],
			// ['H003','犹豫期内电话回访成功率','负'],
			['H003','犹豫期剩余3天内未完成回访的保单','正'],
			['H003','回访不成功但仍在犹豫期内的保单','正'],
			['H004','当日越级件','正'],
			['H005','当日投诉件','正'],
			['H006','保单15日送达率','负'],
			['H007','保全时效','正'],
			['H008','理赔获赔率','负'],
			['H009','投诉件办理及时率','负'],
			['H0010','电话呼入人工接通率','负'],
		];

		//月、年、渠道为全司的指标
		var dataSet2 = [
			['H001','出险支付时效','正'],
			['H002','申请支付时效','正'],
			['H003','犹豫期内电话回访成功率','负'],
			['H004','亿元保费投诉量','正'],
			['H005','万张保单投诉量','正'],
			['H006','保单15日送达率','负'],
			['H007','保全时效','正'],
			['H008','理赔获赔率','负'],
			['H009','投诉件办理及时率','负'],
			['H0010','电话呼入人工接通率','负'],
		];

		//日、渠道为 个险、渠道+健养、电网销 的指标 
		var dataSet3 = [
			['H001','出险支付时效','正'],
			['H002','申请支付时效','正'],
			// ['H003','犹豫期内电话回访成功率','负'],
			['H003','犹豫期剩余3天内未完成回访的保单','正'],
			['H003','回访不成功但仍在犹豫期内的保单','正'],
			['H004','当日越级件','正'],
			['H005','当日投诉件','正']
		];

		//月、年、渠道为 个险、渠道+健养、电网销 的指标 
		var dataSet4 = [
			['H001','出险支付时效','正'],
			['H002','申请支付时效','正'],
			['H003','犹豫期内电话回访成功率','负'],
			['H004','亿元保费投诉量','正'],
			['H005','万张保单投诉量','正'],
		];


		var chooseTime = sessionStorage.chooseTime,//取pIndex.html缓存的 时间
			nyrType = sessionStorage.nyrType,//取pIndex.html缓存的 年/月/日类型
			qdType1 = sessionStorage.qdType1,//取pIndex.html缓存的 渠道
			zbCode1 = sessionStorage.zbCode1,//取pIndex.html缓存的 被选中的指标
			branchNo1 = sessionStorage.branchNo1, 
			zbList = JSON.parse( sessionStorage.zbList1 ),//取pIndex.html缓存的 指标数据
			conHeight = 0;//用于页面布局

		$(function(){

			//在计算.content高度
			var h = $(document).height();
			var hh = $('header')[0].clientHeight;
			var zh = $('.zbType')[0].clientHeight;
			var fh = $('footer')[0].clientHeight;
		
			conHeight = h - hh- zh-fh-10 ;
			$('.content').css('height',conHeight+'px');


			var pos = arrIndex(zbList,zbCode1);

			if(pos > -1){

				//初始化 滑块组件
				swiperContent(pos,zbList.length,( nyrType == '2' ? true:false),nyrType);
				var zb = zbName( pos );
				$('#zbType').text( zb.name ).attr('data-code',zbCode1);
				$('#mEnd').text( chooseTime );
				if(pos == 0){
					queryData(pos,zb.order);//查询数据
				}
				
			}

			if(branchNo1 == '0000000001'){
				mdate(chooseTime,nyrType);
			}
			

			//给 渠道赋值
			$('input[name="qdRadio"]').each(function(index,item){
				if(item.value == qdType1){
					item.checked = true;
					$(item).parent()[0].className = $(item).parent()[0].className+'2';
				}
			});

			//返回 上一页
			$('.back').on('click',function(){
				history.back(0);
			});


			
			

			//渠道选择 委托change事件
			$('footer').delegate('input[name="qdRadio"]','change',function(){
				var label = $(this).parent(),
					val = $(this).val();

				$('footer').find('label').each(function(index,item){
					var className = item.className;
					if(item == label[0]){
						item.className = className+'2';
					}else{
						item.className = className.replace('2','');
					}
				});

				queryZbType(val);

				//查询到的指标有数据
				if(zbList.length){

					//初始化 滑块组件
					swiperContent(0,zbList.length,( nyrType == '2' ? true:false),nyrType);
					var zb = zbName( 0 );
					$('#zbType').text( zb.name ).attr('data-code',zbList[0][0]);
					queryData(0,zb.order);//查询数据
				}
			});

			
			//给机构绑定点击事件
			$('.content').delegate('a','click',function(){

				sessionStorage['branchNo2'] = $(this).attr('data-branch'); //分公司机构号
				sessionStorage['branchName2'] = $(this).attr('data-branchName'); //分公司名称
				//根据不同的机构等级 来存不同的qdType --下级机构可能再选择其他的渠道，所以分开存储
				sessionStorage['qdType2'] = $('input[name="qdRadio"]:checked').val();
				sessionStorage['zbCode2'] = $('#zbType').attr('data-code');

				//存数指标数据
				sessionStorage['zbList2'] = JSON.stringify(zbList);

				window.location.href = 'pInfo3.html';
			});
			
			// 排序的点击事件
			$('.content-box').delegate('[order-by]','click',function(){
				var item = $(this).parents('[swiper-item]'),
					zb = zbName( Number(item.attr('swiper-item')) ),
					index = Number( $(this).attr('order-index')),
					order = $(this).attr('order-by'),
					flg = true,//asc--true,desc--false
					el = $(this)[0];

				//desc--降序 从大到小  asc--升序从小到大	
				if (order == 'no' || order == 'desc') {
                    order = 'asc';
                    flg = true;
                    $(this)[0].className = 'desc2';
                } else if (order == 'asc') {
                    order = 'desc';
                    flg = false;
                   $(this)[0].className = 'desc1';
                }

                item.find('[order-by]').each(function (index, item) {
                    if (item != el) {
                        $(this)[0].className = 'desc0';
                        $(this).attr('order-by','no');
                    }
                });
                if(zb.order=='负') flg = !flg;

                $(this).attr('order-by', order);

                item.find('ul').scrollTop(0).html( dataDeal( orderOrDesc(dataSet0, index, flg,1,zb.order,order) ) );

			});
		});

		function mdate(date,type){

			//显示时间选择层
			$('[data-mdate]').on('click',function(){
				$('.mdate-choose').show();
			});

			//关闭时间选择层
			$('[data-mclose]').on('click',function(){
				$('[data-merr]').text('');
				$('.mdate-choose').hide();
			});

			//清空时间
			$('[data-mclear]').on('click',function(){
				$('#startTime,#endTime').val('');
			});

			//最终确定
			$('[data-confirm]').on('click',function(){
				var start = $('#startTime').val();
				var end = $('#endTime').val();

				if(!start && !end ){
					$('[data-merr]').text('请选择时间');
					return false;
				}else if(!end){
					$('[data-merr]').text('请选择结束时间');
					return false;
				}else if(!start){
					$('[data-merr]').text('请选择开始时间');
					return false;
				}

				if(new Date(start) > new Date(end)){
					$('[data-merr]').text('开始时间不能大于结束时间');
					return false;
				}

				$('#mStart').text(start);
				$('#mEnd').text(end);

				$('.zbType').addClass('scal');
				$('.mdata-content').css('display','inline-block');
				$('[data-merr]').text('');
				$('.mdate-choose').hide();
			});

			var dateOrder = 'yymmdd';
			var dateFormat = 'yy/mm/dd';
			var d = new Date();
			d.setDate(d.getDate()-2);


			if(type == '1'){
				dateOrder = 'yymm';
				dateFormat = 'yy/mm';
			}

			var def = {
				'preset' : 'date',
				'theme' : 'mobiscroll',
				'display' : 'modal',
				'lang' : 'zh',
				'dateOrder' : dateOrder,
				'dateFormat' : dateFormat,
				'startYear' : d.getFullYear(),
				'endYear' : d.getFullYear(),
				'maxDate': d
			};
			
			//绑定时间选择插件
			$('#startTime,#endTime').mobiscroll(def);
		}




		var a = null;

		/**
		 * 查询数据
		 * activeIndex 最新滑动窗口的下标
		 */
		function queryData(activeIndex,order){
			//....ajax
			a = [].concat(dataSet0);
			var list = orderOrDesc(dataSet0, 3, (order == '正' ? true : false ),1,order,'asc');
			$('.swiper-con').eq(activeIndex).html( dataDeal(list) );
		}

		/**
		 * 查询指标类型
		 * type 渠道类型
		 */
		function queryZbType(type){
			//nyrType 年/月/日
			if(type == 0 && nyrType == 0 ){
				zbList = dataSet1;
			}else if(type == 0 && ( nyrType == 1 ||  nyrType == 2 ) ){
				zbList = dataSet2;
			}else if(type != 0 && nyrType == 0){
				zbList = dataSet3;
			}else{
				zbList = dataSet4;
			}
			//ajax  同步请求
		}

        /**
		 * 数据处理
		 * 数据源
		 */
		function dataDeal(list){
			
			var html = '';
			for(var i=0;i<list.length;i++){
				var item = list[i];

				if(i!=0){
					html+='<li>';
				}else{
					html+='<li class="first">';
					
				}
				
				for(var j = 1; j<item.length;j++){
					if(j!=1||i==0){
						if(j != item.length-1){
							if(i!=0 || j != 2){
								html+='<div class="content-item"><span>'+item[j]+'</span></div>';
							}else{
								html+='<div class="content-item"><span>'+(item[j].indexOf('-') < 0 ?'（'+item[j]+'）':item[j])+'</span></div>';
							}
							
						}else{
							html+='<div class="content-item"><span style="color:'+ (item[j] > 0 ? '#32CD32;' : '#FF0000;') +'">'+item[j]+'</span></div>';
						}
					}else{
						html+='<div class="content-item"><a href="javascript:;" data-branch="'+item[0]+'" data-branchName="'+item[j]+'"><span>'+item[j]+'</span></a></div>';
					}
					
				}
				html+='</li>';
			}
			return html;
		}

       
        /**
		 * 初始化滑块 组件  填充内容
		 * maxSWPNum 最大滑块数量
		 * isyear是否为年
		 * type 年/月/日类型 0-日 1-月 2-年
		 * position 指标对应的滑块 
		 */
		function swiperContent(position,maxSWPNum,isyear,type){
			
	   		var html = '<div class="swiper-container"><div class="swiper-wrapper">';
	   		
	   		//swiper-item  这个属性对应每个指标
	   		for(var i = 0;i < maxSWPNum;i++){
	   			html+='<div class="swiper-slide" swiper-item="'+i+'">'+
		        	'<div class="content-title" >'+
						'<div class="content-item"><span>机构</span></div>'+
						'<div class="content-item"><span >排名</span></div>'+
						'<div class="content-item"><span class="desc2" order-index="3" order-by="asc">'+getNYR(type)+'</span></div>'+
						'<div class="content-item"><span class="desc0" order-index="4" order-by="no">'+(!isyear ? '环比':'同比')+'</span></div>'+
					'</div>'+
		        	'<ul class="swiper-con"><li><span>正在查询数据...</span></li></ul>'+
		        '</div>';
	   		}
	   		html+='</div></div><div class="my-pagination"></div>';

	   		$('.content-box').html(html);

	   		//计算容器高度
	   		var ch = $('.content-title')[0].clientHeight;
			$('.swiper-con').css('height',( conHeight - ch - 20)+'px');

	   		if(position > -1) initSpw(position);
		}

		/**
		 * 实例化swiper组件
		 * position 初始位置下标
		 */
		function initSpw(position){
			var swiper = new Swiper('.swiper-container', {
		    	initialSlide:position,//设置初始值
		        pagination: '.my-pagination',
		        onSlidePrevStart:function(sw){
		        	var zb = zbName(sw.activeIndex);
		        	$('#zbType').text( zb.name ).attr('data-code',zb.code);
		        	queryData(sw.activeIndex,zb.order);
		       	},
		       	onSlideNextStart:function(sw){
		       		var zb = zbName(sw.activeIndex);
		        	$('#zbType').text( zb.name ).attr('data-code',zb.code);
		       		queryData(sw.activeIndex,zb.order);
		       	}

		    });
		}

		//获取指标所对应的名字 和 代码
		function zbName(index){
			return {
				'code': zbList[index][0],
				'name': zbList[index][1],
				'order':zbList[index][zbList[index].length-1]
			}
		}

		//获取年/月/日
		function getNYR(type){
			var t = '';
			if(type == '0'){
				t = '本日';
			}else if(type == '1'){
				t = '本月';
			}else{
				t = '本年';
			}
			return t;
		}

		//获取指定元素在数组中的下标
		function arrIndex(arr,val){
			var index = -1;
			for(var i=0;i<arr.length;i++){
				if(val == arr[i][0]){
					index = i;
				}
			}
			return index;
		}

		//****************************** 排序实现 ********************************
		
		/**
		 * 比较大小
		 * a1,a2 要比较的两个值
		 * flg flg ? b1 > b2 : b1 < b2;
		 */
		function bigOrSmall(a1,a2,flg){

            
            if (a1!=0 && ( !a1 || a1 == '-' || isNaN(a1) )) {
                a1 = flg ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
            }
            if (a2!=0 && ( !a2 || a2 == '-' || isNaN(a2) )) {
                a2 = flg ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
            }
            b1 = Number(a1);
            b2 = Number(a2);

            return flg ? b1 > b2 : b1 < b2;
            
		}

		/**
         * arr 数据源
         * index 数组下标  使用数组中的这项来排序
         * flg flg ? b1 > b2 : b1 < b2;
         * noOrder 前几个不用排序  取下标
         * order 正向指标 或 负向指标
         * orderOrDesc 'asc'或 'desc' 
        */
		function orderOrDesc(arr, index, flg,noOrder,order,orderOrDesc) {
			       
            for (var unfix = arr.length - 1; unfix > noOrder; unfix--) {

                for (var i = noOrder; i < unfix; i++) {
                    if (this.bigOrSmall(arr[i][index], arr[i + 1][index],flg)) {
                        var temp = arr[i];
                        arr.splice(i, 1, arr[i + 1]);
                        arr.splice(i + 1, 1, temp);
                    }
                }
            }

            if(orderOrDesc == 'asc'){
            	var b = 1;
            	for(var i=noOrder;i<arr.length;i++){
            		
            		if(arr[i-1] && arr[i][index]!=arr[i-1][index]){
            			b = i;
            		}
            		if(arr[i][index]!='-'){
            			arr[i][2] = b+'';
            		}else{
            			arr[i][2] = '-';
            		}
            		
            	}
            }else{
            	var b = 1;
            	var len = arr.length;
            	var num = 0;//值为'-'的总数
            	for(var i=1;i<=len-noOrder;i++){
            		if(arr[len+1-i] && arr[len+1-i][index]!=arr[len-i][index]){
            			b = i-num;
            		}
            		if(arr[len-i][index]!='-'){
            			arr[len-i][2] = b+'';
            		}else{
            			arr[len-i][2] = '-';
            			num++;
            		}
            		
            	}
            }
            
            return arr;
        }

	</script>
</body>
</html>